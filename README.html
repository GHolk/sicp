<!DOCTYPE html>
<html>
  <meta charset="UTF-8">
  <style>
    #markdown-viewer {
      margin: 0;
      padding: 2%;
      width: 46%;
      position: absolute;
      left: 0;
      top: 0;
    }
    #code-viewer {
      margin: 0;
      border: solid 1px black;
      padding: 2%;
      width: 46%;
      position: fixed;
      right: 0;
      top: 0;
      height: 100%;
      overflow: auto;
    }
  </style>
  <link rel="stylesheet"
        href="highlight-js/styles/default.css">
  <script src="highlight-js/highlight.pack.js"></script>
  
  
  <div id="markdown-viewer"></div>
  <pre id="code-viewer"><code></code></pre>
  <script src="http://gholk.github.io/marked/marked.min.js"></script>
  <script>
    async function fetchText(url) {
      let text
      try {
        const response = await fetch(url)
        text = await response.text()
      }
      catch (fetchError) {
        text = `${url} not found`
      }
      return text
    }
    async function fetchExt(name, extention) {
      const response = extention.map(ext => fetchText(`${name}.${ext}`))
      const text = await Promise.all(response)
      return text
    }
    const highLight = {}
    highLight['markdown-viewer'] = document.querySelector('#markdown-viewer')
    highLight['code-viewer'] = document.querySelector('#code-viewer code')
    highLight['markdown'] = function (markdown) {
      const html = marked(markdown)
      this['markdown-viewer'].innerHTML = html
    }
    highLight['set-code'] = function (code, language) {
      const node = this['code-viewer']
      node.className = language
      node.textContent = code
      hljs.highlightBlock(node)
    }
    highLight['javascript'] = function (code) {
      this['set-code'](code, 'javascript')
    }
    highLight['scheme'] = function (code) {
      this['set-code'](code, 'scheme')
    }
    highLight['emacslisp'] = function (code) {
      this['set-code'](code, 'lisp')
    }
    highLight['text'] = highLight['emacslisp']
    highLight.load = async function (path) {
      const query = decodeQueryString(location.search.slice(1))
      const scan = path.match(/^.*\.(.{1,8})$/)
      let extension
      if (scan) extension = scan[1]
      else {
        path += '/README.md'
        extension = 'md'
      }
      const currentUrl = new URL(query.markdown,  location)
      const nextUrl = new URL(path, currentUrl)
      const text = await fetchText(nextUrl)
      const state = {text}
      switch (extension) {
        case 'js':
          highLight['javascript'](text)
          query['code'] = nextUrl.pathname
          state.type = 'javascript'
          break
        case 'el':
          highLight['emacslisp'](text)
          query['code'] = nextUrl.pathname
          state.type = 'emacslisp'
          break
        case 'sch':
          highLight['scheme'](text)
          query['code'] = nextUrl.pathname
          state.type = 'scheme'
          break
        case 'md':
          highLight['markdown'](text)
          query['markdown'] = nextUrl.pathname
          state.type = 'markdown'
          if (!nextUrl.pathname.match(/README\.md$/)) {
            const scheme = await fetchText(url.replace(/\.md$/, '.sch'))
            highLight['scheme'](scheme)
          }
          break
      }
      const nextQueryString = encodeQueryString(query)
      history.pushState(state, '', '?' + nextQueryString)
    }
    highLight['markdown-viewer']
      .addEventListener('click', function clickAnchor(click) {
      const node = click.target
      if (node.tagName == 'A') {
        if (isRelative(node)) {
          click.preventDefault()
          highLight.load(node.getAttribute('href'))
        }
      }
      function isRelative(node) {
        const url = node.getAttribute('href')
        if (/^http/.test(url)) return false
        else return true
      }
    })
    window.addEventListener('popstate', function (pop) {
      const state = pop.state
      highLight[state.type](state.text)
    })
    highLight.load('README.md')
    function decodeQueryString(string) {
      const pair = string.split(/&/g)
      const map = {}
      pair.filter(string => string).forEach((string) => {
        const pair = string.split('=')
        const name = decodeURIComponent(pair[0])
        const value = decodeURIComponent(pair[1] || '')
        map[name] = value
      })
      return map
    }
    function encodeQueryString(map) {
      const queryArray = []
      for (const name in map) {
        const pairString = encodeURIComponent(name) + '=' +
          encodeURIComponent(map[name])
        queryArray.push(pairString)
      }
      return queryArray.join('&')
    }
      
  </script>

</html>
